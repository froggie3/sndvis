# バタフライ・ネットワーク・ビジュアライザ 仕様書

## 1. 技術スタック選定

この要件を実現するための最適なライブラリ・APIを選定しました。

* **言語:** TypeScript (推奨) または JavaScript (ES6+)
* **描画フレームワーク:** **p5.js**
* 選定理由: 2Dプリミティブ（線、円）の描画に強く、クリエイティブコーディングの表現力が豊かであるため。また、キャンバスのキャプチャも容易です。


* **音声処理:** **Web Audio API + Custom FFT Script**
* 注記: 標準の`AnalyserNode`は使用せず、`AudioWorklet`またはメインスレッドのJSで「Cooley-Tukeyアルゴリズム」を実装し、ステージごとのデータを配列として取り出します。


* **動画書き出し:** **WebM Writer (webm-writer-js等) / MediaRecorder API**
* コンテナ形式: WebM (VP9/VP8)
* ※「WebP」は本来静止画連番（アニメーション）のフォーマットであり、長時間の音声付き動画には不向き（ファイルサイズが巨大になる・音声同期が難しい）です。ブラウザ標準で、かつ高画質・軽量な**WebM**形式を推奨仕様とします。



## 2. システムアーキテクチャ

システムを以下の3つのモジュールに分割します。

詳細なアーキテクチャは[archtecture.md](../archtecture.md)を参照すること。

### A. Core Engine (FFT Processor)

音声データを受け取り、計算過程のスナップショットを提供する計算エンジンです。

* **バッファサイズ:**  または  （視認性を考慮し、あえて小さく設定して拡大表示する、または全周波数帯域から代表的なビンを間引いてネットワーク構築する）
* **計算ステージ:**  段（例: 64サンプルなら6段階）のバタフライ演算ステップ。
* **出力データ:** * `InputBuffer`: 時間領域の入力
* `Stage[0]...Stage[k]`: 各段階の複素数データ
* `OutputBuffer`: 周波数領域の出力



### B. Visualizer (Renderer)

p5.jsを用いてデータを描画します。

* **レイアウト:** 画面左を「時間領域」、右を「周波数領域」とし、その間を配線（バタフライ図）で繋ぐ。
* **ノード表現:** 各計算ポイント（データの交差点）を円で描画。
* 半径 = 振幅（Magnitude）
* 色 = 位相（Phase）または ステージ進捗度


* **ライン表現:** データの流れを示す線。
* エネルギーが流れているラインを明るく発光させる。



### C. IO Manager (Input/Output)

入力ソースと出力モードの切り替えを管理します。

---

## 3. 機能要件詳細

### 3-1. 入力モード

1. **マイク/Line-in入力:**
* `navigator.mediaDevices.getUserMedia` を使用。
* リアルタイム解析のみ（録画はキャプチャのみ対応）。


2. **ファイル入力:**
* ドラッグ＆ドロップまたはファイル選択ダイアログ。
* デコードには `AudioContext.decodeAudioData` を使用。



### 3-2. 動作モード（ファイル入力時）

ここが最も重要な「リアルタイム」と「動画生成」の分岐ロジックです。

**A. リアルタイム再生モード**

* **処理:** `requestAnimationFrame` に従い、音声再生に合わせてその瞬間の波形データを取得し描画。
* **同期:** 音声が主、描画は従（処理落ちしたら描画フレームを飛ばす）。

**B. 動画書き出しモード (Offline Rendering)**

* **処理:** 音声はスピーカーから鳴らしません（またはミュート）。
* **フロー:**
1. Web Audio APIの `OfflineAudioContext` は使わず（FFTの途中経過を取得するため）、**手動で時間を進めるループ**を作ります。
2. `CurrentTime` を  秒ずつインクリメント。
3. 該当時刻のPCMデータを取得し、FFT計算を実行。
4. p5.jsのキャンバスに1フレーム分を描画。
5. キャンバスの内容をBlob化してエンコーダーに追加。
6. 次のフレームへ。


* **メリット:** 計算負荷が高くても、コマ落ちのない完全な60fps動画が生成できます。

### 3-3. UIコントロール

画面下部、またはオーバーレイに以下の設定パネルを配置します。

1. **Source Select:** [ Mic | File ]
2. **Resolution (Combo Box):** * 1280x720 (HD)
* 1920x1080 (FHD)
* 1080x1080 (Instagram/Square)
* 1080x1920 (TikTok/Mobile)


3. **Color Theme:** [ Cyber (Neon) | Paper (Monochrome) | Heatmap ]
4. **Export Button:** 「Render Video」ボタン（ファイル入力時のみ有効）。

---

## 4. 視覚表現の仕様（The Visuals）

バタフライ・ダイアグラムをアートとして昇華させるためのルールです。

* **X軸（横方向）:** FFTのステージ（Stage 0 → Stage N）。左から右へ計算が進む。
* **Y軸（縦方向）:** 配列のインデックス。ただし、バタフライ演算特有の「ビットリバース順（Bit-Reversal Permutation）」を視覚化するため、最終段では周波数順に並び替えられる様子をラインの交差で表現する。
* **インタラクション:**
* 低音（Kick）が入った瞬間、ライン全体が太く脈打つ。
* 高音（Hi-hat）が入ると、画面下部（高周波側）の細かい網目がスパークする。
